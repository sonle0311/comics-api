DÆ°á»›i Ä‘Ã¢y lÃ  **PRD Crawler Controller chÃ­nh thá»©c**, Ä‘Ã£ cáº­p nháº­t Ä‘áº§y Ä‘á»§ cÃ¡c yÃªu cáº§u tá»« báº¡n:

---

# ğŸ“„ PRD â€“ Crawler Controller cho Otruyen API (.NET)

## 1. ğŸ¯ Má»¥c tiÃªu

XÃ¢y dá»±ng má»™t **controller duy nháº¥t** Ä‘á»ƒ crawl dá»¯ liá»‡u tá»« API `https://otruyenapi.com` vÃ  lÆ°u trá»¯ vÃ o há»‡ thá»‘ng database `.NET`. Crawler cáº§n:

* Há»— trá»£ cáº¥u hÃ¬nh pháº¡m vi crawl (tá»« page A Ä‘áº¿n page B)
* Crawl cÃ¡c thá»±c thá»ƒ: **Category**, **Manga**, **Chapter**, **ChapterImage**
* **LÆ°u log chi tiáº¿t theo tá»«ng slug**
* Há»— trá»£ **crawl láº¡i khÃ´ng bá»‹ trÃ¹ng dá»¯ liá»‡u**
* Ghi nháº­n **sá»‘ chÆ°Æ¡ng crawl thÃ nh cÃ´ng / tháº¥t báº¡i**

---

## 2. ğŸš¦ Quy trÃ¬nh crawl

### BÆ°á»›c 1: Crawl thá»ƒ loáº¡i

* Endpoint: `https://otruyenapi.com/v1/api/the-loai`
* LÆ°u vÃ o báº£ng `Category` náº¿u chÆ°a tá»“n táº¡i (`slug` lÃ  khÃ³a chÃ­nh)

### BÆ°á»›c 2: Crawl danh sÃ¡ch truyá»‡n má»›i theo trang

* Endpoint: `https://otruyenapi.com/v1/api/danh-sach/truyen-moi?page={page}`
* Gá»i song song theo cáº¥u hÃ¬nh `pageStart â†’ pageEnd`
* TrÃ­ch `slug` tá»« tá»«ng truyá»‡n
* KhÃ´ng lÆ°u DB á»Ÿ bÆ°á»›c nÃ y

### BÆ°á»›c 3: Crawl thÃ´ng tin truyá»‡n theo `slug`

* Endpoint: `https://otruyenapi.com/v1/api/truyen-tranh/{slug}`
* Thá»±c hiá»‡n:

  * LÆ°u hoáº·c cáº­p nháº­t `Manga` theo `slug`
  * GÃ¡n `Category` (nhiá»u-nhiá»u)
  * LÆ°u danh sÃ¡ch `Chapter`
  * Má»—i `Chapter` cÃ³ `chapter_api_data`

### BÆ°á»›c 4: Crawl áº£nh tá»«ng chÆ°Æ¡ng

* Gá»i tiáº¿p `chapter_api_data` Ä‘á»ƒ láº¥y:

  * Danh sÃ¡ch `chapter_image`
* LÆ°u tá»«ng áº£nh vÃ o báº£ng `ChapterImage` theo `chapter_id` + `page`

---

## 3. ğŸ§© YÃªu cáº§u logic lÆ°u trá»¯ (Idempotency)

| Dá»¯ liá»‡u        | Kiá»ƒm tra trÆ°á»›c khi lÆ°u    | HÃ nh vi khi Ä‘Ã£ tá»“n táº¡i            |
| -------------- | ------------------------- | --------------------------------- |
| `Category`     | `slug`                    | KhÃ´ng thÃªm láº¡i                    |
| `Manga`        | `slug`                    | Cáº­p nháº­t náº¿u cÃ³ khÃ¡c biá»‡t         |
| `Chapter`      | `chapter_name + manga_id` | Bá» qua hoáº·c cáº­p nháº­t náº¿u cho phÃ©p |
| `ChapterImage` | `chapter_id + image_page` | KhÃ´ng lÆ°u láº¡i náº¿u Ä‘Ã£ cÃ³           |

---

## 4. ğŸ“Š Log theo tá»«ng truyá»‡n â€“ `CrawlLog`

### Entity: `CrawlLog`

```csharp
public class CrawlLog
{
    public Guid Id { get; set; }
    public string MangaSlug { get; set; }
    public string MangaName { get; set; }
    public int TotalChapters { get; set; }
    public int ChaptersCrawledSuccess { get; set; }
    public int ChaptersCrawledFailed { get; set; }
    public DateTime CrawledAt { get; set; }
    public List<ChapterLog> FailedChapters { get; set; }
}
```

### Entity: `ChapterLog`

```csharp
public class ChapterLog
{
    public Guid Id { get; set; }
    public string ChapterName { get; set; }
    public string ChapterApiData { get; set; }
    public string? ErrorMessage { get; set; }
}
```

---

## 5. ğŸ§  Controller API

### Controller: `CrawlerController`

```csharp
[ApiController]
[Route("api/crawler")]
public class CrawlerController : ControllerBase
{
    private readonly ICrawlerService _crawlerService;

    [HttpPost("run")]
    public async Task<IActionResult> RunCrawler([FromBody] CrawlRequest request)
    {
        await _crawlerService.CrawlAllAsync(request);
        return Ok(new { message = "Crawl started. Monitor logs for progress." });
    }
}
```

### DTO: `CrawlRequest`

```csharp
public class CrawlRequest
{
    public int PageStart { get; set; } = 1;
    public int PageEnd { get; set; } = 5;
    public bool AllowOverwriteChapters { get; set; } = false;
    public bool EnableLogging { get; set; } = true;
    public bool ReCrawlFailedChapters { get; set; } = true;
}
```

---

## 6. âš™ï¸ Service logic chÃ­nh

```csharp
public async Task CrawlAllAsync(CrawlRequest request)
{
    await CrawlCategoriesAsync();

    var slugs = await CrawlSlugsFromPagesAsync(request.PageStart, request.PageEnd);

    var mangaDetails = await CrawlMangasBySlugsAsync(slugs, request);

    await CrawlAllChapterImagesAsync(mangaDetails, request);
}
```

---

## 7. ğŸ§ª VÃ­ dá»¥ káº¿t quáº£ log

```json
{
  "mangaSlug": "bon-thanh-nu-nga-bai-roi",
  "mangaName": "Bá»•n ThÃ¡nh Ná»¯ NgÃ£ BÃ i Rá»“i",
  "totalChapters": 46,
  "chaptersCrawledSuccess": 45,
  "chaptersCrawledFailed": 1,
  "crawledAt": "2025-07-14T12:35:00Z",
  "failedChapters": [
    {
      "chapterName": "19",
      "chapterApiData": "https://sv1.otruyencdn.com/v1/api/chapter/xxx",
      "errorMessage": "Timeout after 3 retries"
    }
  ]
}
```

---

## 8. ğŸ”’ Xá»­ lÃ½ lá»—i & Retry

* Gá»i API cÃ³ retry logic (Polly hoáº·c custom retry handler)
* Ghi láº¡i lá»—i vÃ o `ChapterLog`
* Cho phÃ©p `ReCrawlFailedChapters = true` Ä‘á»ƒ tá»± Ä‘á»™ng retry

---

## 9. ğŸš€ Má»Ÿ rá»™ng tÆ°Æ¡ng lai

| TÃ­nh nÄƒng          | MÃ´ táº£                                      |
| ------------------ | ------------------------------------------ |
| Lá»c theo updatedAt | Chá»‰ crawl truyá»‡n má»›i hoáº·c má»›i cáº­p nháº­t     |
| Dashboard          | Thá»‘ng kÃª tráº¡ng thÃ¡i crawl theo ngÃ y / slug |
| LÆ°u log ra file    | JSON log cho tá»«ng slug Ä‘á»ƒ debug offline    |
| Giao diá»‡n UI       | Giao diá»‡n nháº­p config vÃ  xem káº¿t quáº£ crawl |

---